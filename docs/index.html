<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>CVBasic online compiler v0.0.15</title>
	<link rel="icon" type="image/x-icon" href="./favicon.ico">
    <style>
      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      textarea.emscripten { font-family: "Press Start 2P", monospace; font-size: 8px; width: calc(100% - 1em); }
      div.emscripten { text-align: center; }
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { border: 0px none; }

      .spinner {
        height: 50px;
        width: 50px;
        margin: 0px auto;
        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;
        border-left: 10px solid rgb(0,150,240);
        border-right: 10px solid rgb(0,150,240);
        border-bottom: 10px solid rgb(0,150,240);
        border-top: 10px solid rgb(100,0,200);
        border-radius: 100%;
        background-color: rgb(200,100,250);
      }
      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }

	  .side-by-side {
		display: flex;
	  }
	  .side-by-side > .left {
		flex: 0 0 50%
	  }
	  .side-by-side > .right {
		flex: 1;
	  }
	  
	  .emulator-container {
		width:100%;
		aspect-ratio: 640 / 480;
		background: blue;
	  }
	  
	  .emulator-container.no-emulator-available {
	    aspect-ratio: auto;
		background: none;
	  }

	  .emulator-container.no-emulator-available #emulator {
		display: none;
	  }
	  
	  .emulator-container:not(.no-emulator-available) .no-emulator-available {
		display: none;
	  }
	  
	  .emulator-container.loading #emulator {
		visibility: hidden;
	  }
	  
	  .half-size-font {
		font-size: 50%;
	  }
	  .github-icon {
		float: right;
		color: black;
		padding-top: 1px;
		padding-right: 1px;
	  }
    </style>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
    <link href="https://unpkg.com/nes.css/css/nes.css" rel="stylesheet" />
	<link href="https://unpkg.com/nes.icons@latest/css/nes-icons.min.css" rel="stylesheet" />	
  </head>
  <body>
	<h1 class="nes-text is-primary">
		<label class="is-primary float-right">CVBasic online compiler v0.0.15</label>
		<a href="https://github.com/haroldo-ok/CVBasic-emscripten" target="_blank" class="github-icon">
			<i class="nes-icon github-square half-size-font"></i>
		</a>
	</h1>
  
    <figure style="overflow:visible;" id="spinner"><div class="spinner"></div><center style="margin-top:0.5em"><strong>emscripten</strong></center></figure>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>  
    </div>
    
	<div class="side-by-side">
		<div class="left nes-container with-title">
			<h3 class="title">CVBasic source code</h3>

			<label for="example-sources" class="half">Example:</label>
			<div class="nes-select">
			  <select required id="example-sources">
				<option value="">-- none --</option>
			  </select>
			</div>
			
			<label for="target-hardware">Target:</label>
			<div class="nes-select">
			  <select required id="target-hardware" onchange="window.gui.handleTargetHardwareClick()">
				<option value="">Standard Colecovision (1K RAM)</option>
				<option value="sg1000">Sega SG-1000/SC-3000 (1K RAM)</option>
				<option value="msx">MSX</option>
				<option value="sgm">Colecovision with Opcode's Super Game Module</option>
				<option value="svi">Spectravideo SVI-318/328 (16K of RAM)</option>
				<option value="sord">Sord M5 (1K RAM)</option>
				<option value="memotech">Memotech MTX (64K RAM)</option>
				<option value="creativision">Vtech Creativision (Dick Smith's Wizzard/Laser 2001), 6502+1K RAM</option>
				<option value="pencil">Soundic/Hanimex Pencil II (2K RAM)</option>
				<option value="einstein">Tatung Einstein, generates .com files</option>
				<option value="pv2000">Casio PV-2000</option>
				<option value="ti994a">Texas Instruments TI-99/4A (32K RAM)</option>
				<option value="nabu">NABU PC (64K RAM)</option>
				<option value="sms">Sega Master System (8K RAM)</option>
			  </select>
			</div>

			<textarea class="emscripten nes-textarea" id="input-basic" rows="24"></textarea>
		</div>
		<div class="right nes-container with-title">
			<h3 class="title">
				<button class="nes-btn is-primary" onclick="window.gui.handleCompileButtonClick()">
					‚ñ∂Ô∏è Compile program
				</button>
				<label>Generated ROM</label>
			</h3>
			
			<button class="nes-btn is-secondary" id="download-generated-rom" onclick="window.gui.handleDownloadButtonClick()">
				üîΩ Download Generated ROM
			</button>
			<button class="nes-btn is-secondary" id="embed-rom-as-html" onclick="window.gui.handleEmbedHtmlButtonClick()">
				üìÑ Embed ROM as HTML
			</button>

			<div class="emulator-container loading">
				<label class="no-emulator-available">No emulator available, yet.</label>
				<div id="emulator"></div>
			</div>
			
			<textarea class="emscripten nes-textarea" id="generated-asm" rows="24" readonly></textarea>
		</div>
	</div>	

	<div class="nes-container with-title">
		<h3 class="title">Messages</h3>
		<textarea class="emscripten nes-textarea" id="output" rows="6" readonly></textarea>
	</div>

	<script src="./compiler-invoker.js?ideVersion=v0.0.15"></script>	 
	
    <script type='text/javascript'>	  
      const inputBasicElement = document.getElementById('input-basic');
      const generatedAsmElement = document.getElementById('generated-asm');
      const outputElement = document.getElementById('output');
	  const exampleSourcesElement = document.getElementById('example-sources');
	  window.targetHardwareElement = document.getElementById('target-hardware');
	  const downloadGeneratedRomButton = document.getElementById('download-generated-rom');	  
	  const downloadEmbedRomAsHtmlButton = document.getElementById('embed-rom-as-html');
	  const emulatorContainerElement = document.getElementsByClassName('emulator-container')[0];
	  
	  const EMULATOR_CORE_NAMES = {
		'': 'coleco',
		'sg1000': 'segaMS',
		'sgm': 'coleco',
		'sms': 'segaMS',
	  };
	  
	  const ROM_EXTENSIONS = {
		'sg1000': 'sg',
		'sms': 'sms',
	  };
	  
	  const SAVED_CODE_KEY = 'cvbasic-usercode-bas';

      generatedAsmElement.value = '';
      outputElement.value = '';
	  
	  window.generatedAssemblyCode = null;
	  
	  const debounce = (callback, wait) => {
		let timeoutId = null;
		return (...args) => {
			window.clearTimeout(timeoutId);
			timeoutId = window.setTimeout(() => {
				callback(...args);
			}, wait);
		};
	  }
	  
	  const selectTextOnInput = (element, textToFind) => {
		const text = element.value;
		const startIndex = text.indexOf(textToFind);
		const endIndex = startIndex + textToFind.length;

		element.focus();
		element.setSelectionRange(startIndex, endIndex);
	  };
	  
	  const blobToBase64 = blob => {
		  return new Promise((onSuccess, onError) => {
			try {
			  const reader = new FileReader();
			  reader.onload = function () {
				onSuccess(this.result);
			  };
			  reader.readAsDataURL(blob);
			} catch (e) {
			  onError(e);
			}
		  });
	  };
	  
	  const compileCode = (basicCode, context) => {
		if (!basicCode) {
			console.warn('Nothing to compile');
			return;
		}
		
		const SOURCE_NAME = 'game';
		const SOURCE_BAS = SOURCE_NAME + '.bas';
		const SOURCE_ASM = SOURCE_NAME + '.asm';
		
		context.FS.writeFile(SOURCE_BAS, basicCode, { encoding: 'utf8' });
		
		const hardwareParams = top.targetHardwareElement.value ? [`--${top.targetHardwareElement.value}`] : [];
		const compilerParams = [SOURCE_BAS, SOURCE_ASM];
		context.Module.callMain([...hardwareParams, ...compilerParams]);
		
		const generatedAssembly = context.FS.readFile(SOURCE_ASM, { encoding: 'utf8' }).split('\n');

		window.setTimeout(() => gui.updateAssembly(generatedAssembly), 0);
	  };
	  
	  const assembleCode = (asmCode, context) => {
		if (!asmCode) {
			console.warn('Nothing to assemble');
			return;
		}
		
		const SOURCE_NAME = 'game';
		const SOURCE_ASM = SOURCE_NAME + '.asm';
		const SOURCE_ROM = SOURCE_NAME + '.rom';
		const SOURCE_LST = SOURCE_NAME + '.lst';
		const SOURCE_SYM = SOURCE_NAME + '.sym';
		
		Module.print('Assembling...');
		context.FS.writeFile(SOURCE_ASM, asmCode, { encoding: 'utf8' });		
		
		const platformParams = document.getElementById('target-hardware').value == 'sms' ? ['-sms'] : [];
		const compilerParams = [SOURCE_ASM, '-o', SOURCE_ROM, '-l', SOURCE_LST, '-s', SOURCE_SYM, ...platformParams];
		context.Module.callMain(compilerParams);

		context.Module.print('Assembled.');
		
		const generatedROM = context.FS.readFile(SOURCE_ROM);
		
		window.setTimeout(() => top.gui.updateEmulator(generatedROM), 0);
	  };
	  	  
	  window.gui = {
	  
		loadExamples: (context) => {
			const loadExample = fileName => {
				inputBasicElement.value = context.FS.readFile('examples/' + fileName, { encoding: 'utf8' });		
				gui.unchangedCode = inputBasicElement.value;
			};

			const exampleFileNames = context.FS.readdir('examples').filter(name => name.endsWith('.bas'));
			exampleFileNames.forEach(fileName => exampleSourcesElement.add(new Option(fileName)));

			if (!inputBasicElement.value) {
				loadExample('face_joystick.bas');
			}
			exampleSourcesElement.addEventListener('click', () => {
				if (exampleSourcesElement.value) loadExample(exampleSourcesElement.value);
			});
		},
	  	  
		handleTargetHardwareClick: () => {
			const emulatorCoreName = EMULATOR_CORE_NAMES[targetHardwareElement.value];			
			emulatorContainerElement.classList.add('loading');
			emulatorContainerElement.classList[emulatorCoreName ? 'remove' : 'add']('no-emulator-available');
			
			window.generatedROM = null;
			gui.checkDownloadButtonEnabled();
			
			gui.closeEmulator();
		},
	  
		handleCompileButtonClick: () => {
			gui.closeEmulator();
			
			window.generatedAssemblyCode = null;
			generatedAsmElement.value = '';
			outputElement.value = '';			

			window.generatedROM = null;
			gui.checkDownloadButtonEnabled();

			// Used to communicate with the iframe while taking string length limitatiions into consideration.
			window.sourceBasicCode = inputBasicElement.value.split('\n');

			compiler.cvbasic.call()
			.then(context => {
				compileCode(inputBasicElement.value, context);
			});
		},
		
		updateAssembly: async (generatedAssembly) => {
			if (!generatedAssembly) return;
		
			generatedAsmElement.value = generatedAssembly.join('\n');
			selectTextOnInput(generatedAsmElement, 'CVBasic program start');			
			
			compiler.gasm80.call()
			.then(context => {
				assembleCode(generatedAsmElement.value, context);
			});
		},
		
		checkDownloadButtonEnabled: () => {
			downloadGeneratedRomButton.classList[window.generatedROM ? 'remove' : 'add']('is-disabled');
			
			const isRomGeneratedAndEmulatorAvailable = window.generatedROM && EMULATOR_CORE_NAMES[targetHardwareElement.value];
			downloadEmbedRomAsHtmlButton.classList[isRomGeneratedAndEmulatorAvailable ? 'remove' : 'add']('is-disabled');
		},
		
		handleDownloadButtonClick: () => {
			if (!window.generatedROM) {
				alert('Sorry, but youm must compile something, first.');
				return;
			}
			
			const fileExtension = ROM_EXTENSIONS[targetHardwareElement.value] || 'rom';
			saveAs(new Blob([window.generatedROM]), 'game-' + new Date().toISOString() + '.' + fileExtension);
		},
		
		handleEmbedHtmlButtonClick: () => {
			if (!window.generatedROM) {
				alert('Sorry, but youm must compile something, first.');
				return;
			}
			
			const fetchBios = biosUrl => {
				return fetch(biosUrl)
				.then(res => res.blob())
				.then(blob => blobToBase64(blob));
			};
			
			const isColecoVision = !targetHardwareElement.value;
			const biosUrlPromise = isColecoVision ? 
				fetchBios('./colecovision.bios.zip') : Promise.resolve('');
			
			biosUrlPromise.then(biosUrl => {
				const base64String = btoa(String.fromCharCode(...generatedROM));

				const emulatorCoreName = EMULATOR_CORE_NAMES[targetHardwareElement.value];
				
				const scriptTag = 'script';
				
				const dedent = rawString => {
					const lines = rawString.split('\n');
					const minIndent = Math.min(...lines.filter(line => line.trim() !== '').map(line => line.match(/^\s*/)[0].length));
					return lines.map(line => line.substring(minIndent)).join('\n').trim();
				};
		
				const generatedHtml = dedent(`
				<html lang="en-us">
				  <head>
					<meta charset="utf-8">
					<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
					<title>CVBasic compiled game</title>
				  </head>
				  <body>
					<div style='width:640px;height:480px;max-width:100%'>
						<div id="emulator"></div>
					</div>
					<${scriptTag}>
						const base64String = "${base64String}";
						const dataArray = Uint8Array.from(atob(base64String), (c) => c.charCodeAt(0));
						const blobUrl = URL.createObjectURL(new Blob([dataArray]));
						
						EJS_player = "#emulator";
						EJS_core = "${emulatorCoreName}";
						EJS_biosUrl = "${biosUrl}";
						EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
						EJS_gameUrl = blobUrl;
					</${scriptTag}>	
					<${scriptTag} src="https://cdn.emulatorjs.org/stable/data/loader.js"></${scriptTag}>	 
				  </body>
				</html>
				`);
				
				saveAs(new Blob([generatedHtml]), 'game-' + new Date().toISOString() + '.html');
			});
		},
		
		monkeyPatchEmulator: () => {
			if (EmulatorJS.prototype._originalHandleResize) return;
		
			EmulatorJS.prototype._originalHandleResize = EmulatorJS.prototype.handleResize;
			EmulatorJS.prototype.handleResize = () => {};
		},
		
		closeEmulator: () => {
			if (!window.EJS_emulator) return;

			window.gui.monkeyPatchEmulator();
			try {
				EJS_emulator.callEvent('exit');
			} catch (e) {
				console.warn('Error while closing emulator', e);
			}
		},
		
		updateEmulator: async (generatedROM) => {
			window.generatedROM = generatedROM;
			gui.checkDownloadButtonEnabled();
		
			const base64String = btoa(String.fromCharCode(...generatedROM));
			const dataUrl = `data:application/octet-stream;base64,${base64String}`;
			
			EJS_emulator.config.system = EMULATOR_CORE_NAMES[targetHardwareElement.value];
			EJS_emulator.config.gameUrl = URL.createObjectURL(new Blob([generatedROM]));
			EJS_emulator.config.startOnLoad = true;
			
			emulatorContainerElement.classList.remove('loading');

			if (!EJS_emulator.config.system) return;
			EJS_emulator = new EmulatorJS(EJS_player, EJS_emulator.config);
			EJS_emulator.handleResize = () => {};
		},
		
		captureEmulatorEvents: () => {
			const KEYS_TO_IGNORE = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
			const preventDefaultIfArrowPressed = event => {
				if (!KEYS_TO_IGNORE.includes(event.key)) return;
				event.preventDefault();
			};
			emulatorContainerElement.addEventListener('keydown', preventDefaultIfArrowPressed);
			emulatorContainerElement.addEventListener('keyup', preventDefaultIfArrowPressed);
		},
		
		loadCodeEditorContent: () => {
			inputBasicElement.value = localStorage[SAVED_CODE_KEY];
			gui.unchangedCode = inputBasicElement.value;
		},
		
		captureCodeEditorEvents: () => {	
			const handleCodeEditorInput = () => {
				if ((gui.unchangedCode || '') == inputBasicElement.value) {
					console.info('Unchanged!');
					return;
				}
			
				console.info('Changed!');
				localStorage[SAVED_CODE_KEY] = inputBasicElement.value;
				gui.unchangedCode = inputBasicElement.value;
			};
			
			const handleCodeEditorInputDebounced = debounce(handleCodeEditorInput, 300);
		
			inputBasicElement.addEventListener('keydown', handleCodeEditorInputDebounced);
			inputBasicElement.addEventListener('keyup', handleCodeEditorInputDebounced);
			inputBasicElement.addEventListener('blur', handleCodeEditorInput);
			
			gui.loadCodeEditorContent();
		},

		captureEvents: () => {
			gui.captureEmulatorEvents();
			gui.captureCodeEditorEvents();
		},
	  };
	  
	  window.setTimeout(() => compiler.cvbasic.call().then(gui.loadExamples), 0);
	  window.setTimeout(() => gui.handleTargetHardwareClick(), 0);
	  window.setTimeout(() => gui.captureEvents(), 0);
    </script>
	
    <script async type="text/javascript" src="FileSaver.js"></script>
	 
	<script>
		EJS_player = "#emulator";
		EJS_core = "coleco";
		EJS_biosUrl = './colecovision.bios.zip';
		EJS_pathtodata = "https://cdn.emulatorjs.org/stable/data/";
		EJS_gameUrl = null;
	</script>	
	<script src="https://cdn.emulatorjs.org/stable/data/loader.js"></script>	 
  </body>
</html>
